
-- 2. B?ng THELOAI
CREATE TABLE THELOAI (
    MATHELOAI INT PRIMARY KEY,
    TENTHELOAI NVARCHAR2(50) UNIQUE
);

-- 3. B?ng TACGIA
CREATE TABLE TACGIA (
    MATACGIA INT PRIMARY KEY,
    TENTACGIA NVARCHAR2(100) NOT NULL UNIQUE
);

-- 4. B?ng NXB (Nhà Xu?t B?n)
CREATE TABLE NXB (
    MANXB INT PRIMARY KEY,
    TENNXB NVARCHAR2(100) NOT NULL UNIQUE,
    DIACHI NVARCHAR2(255)
);

-- 5. B?ng SACH
CREATE TABLE SACH (
    MASACH INT PRIMARY KEY,
    TENSACH NVARCHAR2(100) NOT NULL,
    MOTA NVARCHAR2(255),
    MATHELOAI INT,
    MATACGIA INT,
    MANXB INT,
    NAMXUATBAN INT CHECK (NAMXUATBAN BETWEEN 1500 AND 2100),
    SOTRANG INT CHECK (SOTRANG > 0),
    SOTIENSACH INT DEFAULT 0 CHECK (SOTIENSACH >= 0),
    CONSTRAINT FK_SACH_THELOAI FOREIGN KEY (MATHELOAI) REFERENCES THELOAI(MATHELOAI),
    CONSTRAINT FK_SACH_TACGIA FOREIGN KEY (MATACGIA) REFERENCES TACGIA(MATACGIA),
    CONSTRAINT FK_SACH_NXB FOREIGN KEY (MANXB) REFERENCES NXB(MANXB)
);

-- 6. B?ng DOCGIA
CREATE TABLE DOCGIA (
    MADOCGIA INT PRIMARY KEY,
    HOTEN NVARCHAR2(100) NOT NULL,
    NGAYSINH DATE,
    DIACHI NVARCHAR2(255),
    SODT NVARCHAR2(15) UNIQUE,
    EMAIL NVARCHAR2(50) UNIQUE
);

-- 7. B?ng MUONTRA
CREATE TABLE MUONTRA (
    MAMT INT PRIMARY KEY,
    MADOCGIA INT,
    MASACH INT,
    NGAYMUON DATE NOT NULL,
    NGAYTRA DATE,
    TINHTRANG NVARCHAR2(50) CHECK (TINHTRANG IN ('Ð? tr?', 'Chýa tr?')),
    CONSTRAINT FK_MUONTRA_DOCGIA FOREIGN KEY (MADOCGIA) REFERENCES DOCGIA(MADOCGIA),
    CONSTRAINT FK_MUONTRA_SACH FOREIGN KEY (MASACH) REFERENCES SACH(MASACH)
);

-- 8. B?ng PHIEU_THU
CREATE TABLE PHIEU_THU (
    MAPHIEU INT PRIMARY KEY,
    MAMT INT,
    NGAYTHU DATE DEFAULT SYSDATE,
    SOTIEN INT,
    CONSTRAINT CK_SOTIEN CHECK (SOTIEN >= 0),
    CONSTRAINT FK_PHIEU_THU_MUONTRA FOREIGN KEY (MAMT) REFERENCES MUONTRA(MAMT)
);

-- 9. B?ng NHANVIEN
CREATE TABLE NHANVIEN (
    MANV INT PRIMARY KEY,
    HOTEN NVARCHAR2(100),
    DIACHI NVARCHAR2(255),
    EMAIL NVARCHAR2(100) UNIQUE,
    SDT NVARCHAR2(15) UNIQUE
);

-- 10. B?ng PHIEU_NHAP_SACH
CREATE TABLE PHIEU_NHAP_SACH (
    MAPHIEUNHAP INT PRIMARY KEY,
    MASACH INT,
    NGAYNHAP DATE DEFAULT SYSDATE,
    SOLUONG INT CHECK (SOLUONG > 0),
    MANV INT,
    CONSTRAINT FK_PHIEU_NHAP_SACH FOREIGN KEY (MASACH) REFERENCES SACH(MASACH),
    CONSTRAINT FK_PHIEU_NHAP_NV FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)
);


--THE LOAI
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (1, 'Khoa h?c');
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (2, 'Vãn h?c');
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (3, 'L?ch s?');
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (4, 'Toán h?c');
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (5, 'Sinh h?c');
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (6, 'Ngôn ng? h?c');
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (7, 'V?t l?');
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (8, 'Âm nh?c');
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (9, 'Tri?t h?c');
INSERT INTO THELOAI (MATHELOAI, TENTHELOAI) VALUES (10, 'K? toán');

COMMIT;



-- TACGIA
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (1, 'Nguy?n Du');
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (2, 'Albert Einstein');
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (3, 'Lenin');
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (4, 'Euclid');
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (5, 'Mendel');
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (6, 'Fibonacci');
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (7, 'Isaac Newton');
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (8, 'Nam Cao');
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (9, 'C-Mác');
INSERT INTO TACGIA (MATACGIA, TENTACGIA) VALUES (10, 'Nguy?n H?u Cý?ng');

COMMIT;


-- NXB
INSERT ALL
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (1, 'NXB Giáo D?c Hà N?i', 'Hà N?i')
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (2, 'NXB Tr?', 'TP.HCM')
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (3, 'NXB Giáo D?c Ðà N?ng', 'Ðà N?ng')
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (4, 'NXB Kim Ð?ng Hu?', 'Hu?')
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (5, 'NXB H?i Nhà vãn', 'Hà N?i')
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (6, 'NXB Toán h?c', 'Nam Ð?nh')
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (7, 'NXB Kim Ð?ng Ðà L?t', 'Ðà L?t')
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (8, 'NXB Ð?i h?c Qu?c gia', 'TP.HCM')
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (9, 'NXB Kim Ð?ng Qu?ng Ninh', 'Qu?ng Ninh')
    INTO NXB (MANXB, TENNXB, DIACHI) VALUES (10, 'NXB Nhà Nam', 'Tây Ninh')
SELECT 1 FROM DUAL;

COMMIT;

-- SACH
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (1, 'Truy?n Ki?u', 'Truy?n Ki?u c?a Nguy?n Du', 2, 1, 1, 1800, 300, 100);
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (2, 'V?t L? Cõ B?n', 'Sách V?t l? cõ b?n', 7, 2, 1, 1905, 400, 150);
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (3, 'L?ch S? Th? Gi?i', 'T?ng h?p l?ch s? th? gi?i', 3, 3, 2, 1950, 500, 200);
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (4, 'Nguyên L? Toán H?c', 'Công tr?nh c?a Euclid', 4, 4, 5, 1700, 250, 120);
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (5, 'Di truy?n h?c', 'Nghiên c?u c?a Mendel', 5, 5, 1, 1865, 320, 130);
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (6, 'D?y s? Fibonacci', 'Toán h?c ?ng d?ng', 6, 6, 2, 1602, 180, 140);
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (7, 'Chí Phèo', 'Tác ph?m Nam Cao', 2, 8, 4, 1941, 210, 160);
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (8, 'Bàn lu?n', 'N.Mác biên so?n', 9, 9, 9, 1867, 600, 300);
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (9, 'Ch?ng minh 8 ð? cõ b?n', 'Ngô B?o Châu', 4, 10, 10, 2010, 350, 500);
INSERT INTO SACH (MASACH, TENSACH, MOTA, MATHELOAI, MATACGIA, MANXB, NAMXUATBAN, SOTRANG, SOTIENSACH) VALUES (10, 'Tri?t h?c Lenin', 'L? lu?n chính tr?', 9, 3, 7, 1917, 280, 170);
-- Thêm COMMIT ð? lýu các thay ð?i vào DB v?nh vi?n
COMMIT;

-- DOCGIA
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (1, 'Nguy?n Vãn Ân', TO_DATE('1995-05-20', 'YYYY-MM-DD'), 'Hà N?i', '0912345678', 'vanan@gmail.com');
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (2, 'Tr?n Th? B?nh', TO_DATE('2000-01-15', 'YYYY-MM-DD'), 'TP.HCM', '0911111111', 'tranb@gmail.com');
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (3, 'Lê Vãn C?u', TO_DATE('1998-03-10', 'YYYY-MM-DD'), 'Ðà N?ng', '0922222222', 'levanc@gmail.com');
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (4, 'Ph?m Duy', TO_DATE('1997-07-12', 'YYYY-MM-DD'), 'Hu?', '0933333333', 'phamd@gmail.com');
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (5, 'Hoàng Em', TO_DATE('1996-02-02', 'YYYY-MM-DD'), 'H?i Ph?ng', '0944444444', 'hoange@gmail.com');
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (6, 'Ngô Phùng Hýng', TO_DATE('1999-08-19', 'YYYY-MM-DD'), 'Nam Ð?nh', '0955555555', 'ngof@gmail.com');
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (7, 'Bùi Giang', TO_DATE('1995-09-25', 'YYYY-MM-DD'), 'Qu?ng Ninh', '0966666666', 'buig@gmail.com');
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (8, 'Ð? H?u', TO_DATE('2001-11-30', 'YYYY-MM-DD'), 'Hà Nam', '0977777777', 'doh@gmail.com');
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (9, 'Nguy?n Y?n', TO_DATE('1994-12-05', 'YYYY-MM-DD'), 'Ninh B?nh', '0988888888', 'nguyeni@gmail.com');
INSERT INTO DOCGIA (MADOCGIA, HOTEN, NGAYSINH, DIACHI, SODT, EMAIL) VALUES (10, 'Phan Khánh', TO_DATE('2002-06-22', 'YYYY-MM-DD'), 'Thái B?nh', '0999999999', 'phank@gmail.com');
COMMIT;

-- MUONTRA
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (1, 1, 1, TO_DATE('2025-09-10', 'YYYY-MM-DD'), TO_DATE('2025-09-17', 'YYYY-MM-DD'), 'Ð? tr?');
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (2, 2, 2, TO_DATE('2025-09-12', 'YYYY-MM-DD'), NULL, 'Chýa tr?');
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (3, 3, 3, TO_DATE('2025-09-13', 'YYYY-MM-DD'), NULL, 'Chýa tr?');
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (4, 4, 4, TO_DATE('2025-09-14', 'YYYY-MM-DD'), TO_DATE('2025-09-18', 'YYYY-MM-DD'), 'Ð? tr?');
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (5, 5, 5, TO_DATE('2025-09-15', 'YYYY-MM-DD'), NULL, 'Chýa tr?');
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (6, 6, 6, TO_DATE('2025-09-16', 'YYYY-MM-DD'), NULL, 'Chýa tr?');
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (7, 7, 7, TO_DATE('2025-09-17', 'YYYY-MM-DD'), NULL, 'Chýa tr?');
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (8, 8, 8, TO_DATE('2025-09-18', 'YYYY-MM-DD'), TO_DATE('2025-09-20', 'YYYY-MM-DD'), 'Ð? tr?');
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (9, 9, 9, TO_DATE('2025-09-18', 'YYYY-MM-DD'), NULL, 'Chýa tr?');
INSERT INTO MUONTRA (MAMT, MADOCGIA, MASACH, NGAYMUON, NGAYTRA, TINHTRANG) VALUES (10, 10, 10, TO_DATE('2025-09-18', 'YYYY-MM-DD'), NULL, 'Chýa tr?');

COMMIT;

-- PHIEU_THU
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(1, 1, TO_DATE('2025-09-17', 'YYYY-MM-DD'), 100);
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(2, 4, TO_DATE('2025-09-18', 'YYYY-MM-DD'), 120);
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(3, 8, TO_DATE('2025-09-20', 'YYYY-MM-DD'), 150);
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(4, 2, TO_DATE('2025-09-19', 'YYYY-MM-DD'), 200);
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(5, 3, TO_DATE('2025-09-19', 'YYYY-MM-DD'), 180);
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(6, 5, TO_DATE('2025-09-20', 'YYYY-MM-DD'), 210);
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(7, 6, TO_DATE('2025-09-20', 'YYYY-MM-DD'), 90);
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(8, 7, TO_DATE('2025-09-20', 'YYYY-MM-DD'), 130);
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(9, 9, TO_DATE('2025-09-21', 'YYYY-MM-DD'), 300);
INSERT INTO PHIEU_THU (MAPHIEU, MAMT, NGAYTHU, SOTIEN) VALUES(10, 10, TO_DATE('2025-09-21', 'YYYY-MM-DD'),250);
COMMIT;

-- NHANVIEN
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (1, 'Tr?n Bùi', 'Hà N?i', 'tranb@gmail.com', '0987654321');
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (2, 'Nguy?n Vãn V?nh', 'H?i Ph?ng', 'nguyenc@gmail.com', '0912123456');
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (3, 'Lê Duy C?u', 'Ðà N?ng', 'led@gmail.com', '0912345123');
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (4, 'Ph?m Y?n Em', 'Hu?', 'phame@gmail.com', '0921345678');
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (5, 'Hoàng Phú Qu?', 'Nam Ð?nh', 'hoangf@gmail.com', '0931456789');
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (6, 'Ngô Gia Hào', 'TP.HCM', 'ngog@gmail.com', '0941567890');
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (7, 'Bùi Huy Ích', 'Qu?ng Ninh', 'buih@gmail.com', '0951678901');
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (8, 'Ð? Lâm An', 'H?i Dýõng', 'doi@gmail.com', '0961789012');
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (9, 'Nguy?n Khánh Toàn', 'Thái B?nh', 'nguyenj@gmail.com', '0971890123');
INSERT INTO NHANVIEN(MANV, HOTEN, DIACHI, EMAIL, SDT) VALUES (10, 'Phan Khanh Nhàn', 'Thanh Hóa', 'phanknv@gmail.com', '0981901234');
COMMIT;


-- PHIEU_NHAP_SACH
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (1, 2, TO_DATE('2025-08-01', 'YYYY-MM-DD'), 50, 1);
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (2, 3, TO_DATE('2025-08-02', 'YYYY-MM-DD'), 40, 2);
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (3, 4, TO_DATE('2025-08-03', 'YYYY-MM-DD'), 30, 3);
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (4, 5, TO_DATE('2025-08-04', 'YYYY-MM-DD'), 60, 4);
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (5, 6, TO_DATE('2025-08-05', 'YYYY-MM-DD'), 20, 5);
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (6, 7, TO_DATE('2025-08-06', 'YYYY-MM-DD'), 25, 6);
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (7, 8, TO_DATE('2025-08-07', 'YYYY-MM-DD'), 15, 7);
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (8, 9, TO_DATE('2025-08-08', 'YYYY-MM-DD'), 35, 8);
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (9, 10, TO_DATE('2025-08-09', 'YYYY-MM-DD'), 45, 9);
INSERT INTO PHIEU_NHAP_SACH(MAPHIEUNHAP, MASACH, NGAYNHAP, SOLUONG, MANV) VALUES (10, 1, TO_DATE('2025-08-10', 'YYYY-MM-DD'), 55, 10);
COMMIT;

SELECT *FROM THELOAI
SELECT *FROM TACGIA
SELECT *FROM NXB
SELECT * FROM SACH
SELECT *FROM DOCGIA
SELECT *FROM MUONTRA
SELECT *FROM PHIEU_THU
SELECT *FROM NHANVIEN
SELECT *FROM PHIEU_NHAP_SACH


--MaHoaCong
CREATE OR REPLACE FUNCTION encode_add(input_str VARCHAR2, key NUMBER) RETURN VARCHAR2 IS
    result VARCHAR2(32767) := '';
    i NUMBER;
    ch CHAR(1);
    code NUMBER;
BEGIN
    FOR i IN 1..LENGTH(input_str) LOOP
        ch := SUBSTR(input_str, i, 1);
        code := ASCII(ch);
        -- Ch? mã hóa ký t? bàn phím, gi? nguyên ngoài ph?m vi
        IF code BETWEEN 32 AND 126 THEN
            code := MOD(code - 32 + key, 95) + 32;
        END IF;
        result := result || CHR(code);
    END LOOP;
    RETURN result;
END;
/
--GiaiMaCong
CREATE OR REPLACE FUNCTION decode_add(input_str VARCHAR2, key NUMBER) RETURN VARCHAR2 IS
    result VARCHAR2(32767) := '';
    i NUMBER;
    ch CHAR(1);
    code NUMBER;
BEGIN
    FOR i IN 1..LENGTH(input_str) LOOP
        ch := SUBSTR(input_str, i, 1);
        code := ASCII(ch);
        IF code BETWEEN 32 AND 126 THEN
            code := MOD(code - 32 - key + 95, 95) + 32;
        END IF;
        result := result || CHR(code);
    END LOOP;
    RETURN result;
END;
/
--MaHoaNhan
CREATE OR REPLACE FUNCTION encode_mul(input_str VARCHAR2, key NUMBER) RETURN VARCHAR2 IS
    result VARCHAR2(32767) := '';
    i NUMBER;
    ch CHAR(1);
    code NUMBER;
BEGIN
    FOR i IN 1..LENGTH(input_str) LOOP
        ch := SUBSTR(input_str, i, 1);
        code := ASCII(ch);
        IF code BETWEEN 32 AND 126 THEN
            code := MOD((code - 32) * key, 95) + 32;
        END IF;
        result := result || CHR(code);
    END LOOP;
    RETURN result;
END;
/

--GiaiMaNhan
CREATE OR REPLACE FUNCTION decode_mul(input_str VARCHAR2, key NUMBER) RETURN VARCHAR2 IS
    result VARCHAR2(32767) := '';
    i NUMBER;
    ch CHAR(1);
    code NUMBER;
    inv_key NUMBER;
    function modinv(a IN NUMBER, m IN NUMBER) RETURN NUMBER IS
        t NUMBER := 0;
        newt NUMBER := 1;
        r NUMBER := m;
        newr NUMBER := a;
        quotient NUMBER;
        temp NUMBER;
    BEGIN
        WHILE newr <> 0 LOOP
            quotient := FLOOR(r / newr);
            temp := t - quotient * newt;
            t := newt;
            newt := temp;
            temp := r - quotient * newr;
            r := newr;
            newr := temp;
        END LOOP;
        IF r > 1 THEN
            RETURN NULL;
        END IF;
        IF t < 0 THEN
            t := t + m;
        END IF;
        RETURN t;
    END;
BEGIN
    inv_key := modinv(key, 95);
    IF inv_key IS NULL THEN
        RAISE_APPLICATION_ERROR(-20001, 'Key không có ngh?ch ??o modulo 95');
    END IF;

    FOR i IN 1..LENGTH(input_str) LOOP
        ch := SUBSTR(input_str, i, 1);
        code := ASCII(ch);
        IF code BETWEEN 32 AND 126 THEN
            code := MOD((code - 32) * inv_key, 95) + 32;
        END IF;
        result := result || CHR(code);
    END LOOP;
    RETURN result;
END;
/

--DES
SET SERVEROUTPUT ON;

CREATE OR REPLACE PACKAGE DES
AS
    FUNCTION ENCRYPT (P_PLAINTEXT VARCHAR2, PRIKEY VARCHAR2) RETURN RAW DETERMINISTIC;
    FUNCTION DECRYPT (P_ENCRYPTEDTEXT RAW, PRIKEY VARCHAR2) RETURN VARCHAR2 DETERMINISTIC;
END;
/
CREATE OR REPLACE PACKAGE BODY DES
AS
    ENCRYPTION_TYPE PLS_INTEGER := DBMS_CRYPTO.ENCRYPT_DES
                                 + DBMS_CRYPTO.CHAIN_CBC
                                 + DBMS_CRYPTO.PAD_PKCS5;
    FUNCTION ENCRYPT (P_PLAINTEXT VARCHAR2, PRIKEY VARCHAR2) RETURN RAW DETERMINISTIC
    IS
        ENCRYPTION_KEY RAW (32) := UTL_RAW.CAST_TO_RAW(PRIKEY);
        ENCRYPTED_RAW RAW (2000);
    BEGIN
        ENCRYPTED_RAW := DBMS_CRYPTO.ENCRYPT
        (
            SRC => UTL_RAW.CAST_TO_RAW (P_PLAINTEXT),
            TYP => ENCRYPTION_TYPE,
            KEY => ENCRYPTION_KEY
        );
        RETURN ENCRYPTED_RAW;
    END ENCRYPT;
    
    FUNCTION DECRYPT (P_ENCRYPTEDTEXT RAW, PRIKEY VARCHAR2) RETURN VARCHAR2 DETERMINISTIC
    IS
        ENCRYPTION_KEY RAW (32) := UTL_RAW.CAST_TO_RAW(PRIKEY);
        DECRYPTED_RAW RAW (2000);
    BEGIN
        DECRYPTED_RAW := DBMS_CRYPTO.ENCRYPT
        (
            SRC => P_ENCRYPTEDTEXT,
            TYP => ENCRYPTION_TYPE,
            KEY => ENCRYPTION_KEY
        );
        RETURN (UTL_RAW.CAST_TO_VARCHAR2 (DECRYPTED_RAW));
    END DECRYPT;
END;
/

DECLARE
    PLAINTEXT NVARCHAR2(200) :='HELLO WORLD';
    CIPHERTEXT RAW(2000);
BEGIN
    CIPHERTEXT := DES.ENCRYPT(PLAINTEXT, 'PRIVATEKEY');
    DMBS_OUTPUT.PUT_LINE('ENCRYPTED: ' || CIPHERTEXT);
    DBMS_OUTPUT.PUT_LINE('DECRYPTED: ' || DES.DECRYPT(CIPHERTEXT, 'PRIVATEKEY'));
END;